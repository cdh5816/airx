// Â© AIRX (individual business). All rights reserved.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  users     User[]
  sites     Site[]
  documents Document[]
  // ... other relations
}

model User {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id])
  username          String   @unique
  passwordHash      String
  role              Role
  mustChangePassword Boolean @default(true)
  deletedAt         DateTime?
  createdAt         DateTime @default(now())
  notifications     Notification[]
  favorites         Favorite[]
  auditLogs         AuditLog[] @relation("actor")
}

enum Role {
  SUPER_ADMIN
  MID_ADMIN
  ADMIN
  STAFF
  CLIENT
}

model GuestUser {
  id         String   @id @default(cuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  username   String
  memo       String
  isActive   Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt  DateTime @default(now())
  accesses   GuestSiteAccess[]
}

model Site {
  id            String   @id @default(cuid())
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id])
  name          String
  address       String?
  status        SiteStatus @default(ONGOING)
  assigneeUserId String?
  createdAt     DateTime @default(now())
  requests      Request[]
  documents     Document[]
}

enum SiteStatus {
  ONGOING
  CONTRACTED
  CONSTRUCTION
  COMPLETED
  CLOSED
}

model GuestSiteAccess {
  id        String  @id @default(cuid())
  companyId String
  guestId   String
  siteId    String
  createdAt DateTime @default(now())
  @@unique([guestId, siteId])
}

model Document {
  id            String   @id @default(cuid())
  companyId     String
  siteId        String
  type          DocumentType
  isPublicToGuest Boolean @default(false)
  fileUrl       String
  createdAt     DateTime @default(now())
}

enum DocumentType {
  START
  COMPLETION
  REPORT
  OTHER
}

model Request {
  id             String   @id @default(cuid())
  companyId      String
  siteId         String
  createdByType  CreatedByType
  createdById    String
  content        String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime @default(now())
}

enum CreatedByType {
  USER
  GUEST
}

enum RequestStatus {
  PENDING
  IN_PROGRESS
  DONE
}

model Notification {
  id        String   @id @default(cuid())
  companyId String
  userId    String
  targetUrl String
  title     String
  createdAt DateTime @default(now())
  isRead    Boolean  @default(false)
}

model Favorite {
  id        String @id @default(cuid())
  companyId String
  userId    String
  siteId    String
  createdAt DateTime @default(now())
  @@unique([userId, siteId])
}

model PasswordChangeRequest {
  id               String   @id @default(cuid())
  companyId        String
  requesterUserId  String
  newPasswordHash  String
  status           PCRStatus @default(PENDING)
  decidedByUserId  String?
  reason           String?
  createdAt        DateTime @default(now())
  decidedAt        DateTime?
}

enum PCRStatus {
  PENDING
  APPROVED
  REJECTED
}

model LeaveRequest {
  id        String @id @default(cuid())
  companyId String
  userId    String
  type      String
  dateFrom  DateTime
  dateTo    DateTime
  status    String
}

model Attendance {
  id        String @id @default(cuid())
  companyId String
  userId    String
  type      String
  at        DateTime
}

model AuditLog {
  id         String   @id @default(cuid())
  companyId  String
  actorUserId String
  action     String
  payloadJson String?
  createdAt  DateTime @default(now())
}
